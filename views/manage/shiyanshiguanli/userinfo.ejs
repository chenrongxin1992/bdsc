<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>个人资料</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="format-detection" content="telephone=no">
	<link rel="stylesheet" href="../layui/css/layui.css" media="all" />
	<link rel="stylesheet" href="../stylesheets/public.css" media="all" />
	<style type="text/css">
		.tdstyle{
			width:120px;
			background-color: #009688;
			color:#fff;
			text-align: center;
		}
		.btnfloat{
			float: right;
		}
		.w-e-text-container{
	    	height: 150px !important;
	    }
	</style>
</head>
<body class="childrenBody">
	<blockquote class="layui-elem-quote" style="line-height: 30px;">个人资料<div id="btnele" style="display: inline;"><button class="layui-btn layui-btn-sm btnfloat" id="editbtn">编辑</button></div></blockquote>
	<form class="layui-form" action="">
	<table class="layui-table" id="shiyanshizhuren">
	    <tbody>
	      <tr>
	        <td class="tdstyle">姓名</td>
	        <td><input type="text" id="name" class="layui-input" disabled="" value="<%=user.name%>"></td>
	        <td class="tdstyle">(英文)姓名</td>
	        <td><input type="text" id="ename" class="layui-input" disabled="" value="<%=user.ename%>"></td>
	        <td rowspan="5" style="text-align: center;"><img id="userimg" src="<%=user.photo%>" style="width:auto;height:auto;max-width:150px;max-height:100%;margin:5px;"><div id="uploadarea"><div class="layui-upload-list"><p id="demoText"></p></div></div></td>
	      </tr>
	      <tr>
	        <td class="tdstyle">性别</td>
	        <td id="tdgender"><input type="text" id="gender" class="layui-input" disabled="" value="<%=user.gender%>"></td>
	        <td class="tdstyle">类别</td>
	        <td id="tddegree"><input type="text" id="degree" class="layui-input" disabled="" value="<%=user.degree%>"></td>
	      </tr>
	      <tr>
	        <td class="tdstyle">职称</td>
	        <td><input type="text" id="title" class="layui-input" disabled="" value="<%=user.title%>"></td>
	        <td class="tdstyle">(英文)职称</td>
	        <td><input type="text" id="etitle" class="layui-input" disabled="" value="<%=user.etitle%>"></td>
	      </tr>
	      <tr>
	        <td class="tdstyle">电话</td>
	        <td ><input type="text" id="phone" class="layui-input" disabled="" value="<%=user.phone%>"></td>
	        <td class="tdstyle">Email</td>
	        <td ><input type="text" id="email" class="layui-input" disabled="" value="<%=user.email%>"></td>
	      </tr>
	      <tr>
	        <td class="tdstyle">住址</td>
	        <td ><input type="text" id="address" class="layui-input" disabled="" value="<%=user.address%>"></td>
	        <td class="tdstyle">(英文)住址</td>
	        <td><input type="text" id="eaddress" class="layui-input" disabled="" value="<%=user.eaddress%>"></td>
	      </tr>
	      <tr>
	        <td class="tdstyle">专业</td>
	        <td ><input type="text" id="profession" class="layui-input" disabled="" value="<%=user.profession%>"></td>
	        <td class="tdstyle">(英文)专业</td>
	        <td colspan="2"><input type="text" id="eprofession" class="layui-input" disabled="" value="<%=user.profession%>"></td>
	      </tr>
	      <tr>
	        <td class="tdstyle">研究方向</td>
	        <td ><input type="text" id="researcharea" class="layui-input" disabled="" value="<%=user.researcharea%>"></td>
	        <td class="tdstyle">(英文)研究方向</td>
	        <td colspan="2"><input type="text" id="eresearcharea" class="layui-input" disabled="" value="<%=user.eresearcharea%>"></td>
	      </tr>
	      <tr>
	        <td class="tdstyle">导师</td>
	        <td ><input type="text" id="tutor" class="layui-input" disabled="" value="<%=user.tutor%>"></td>
	        <td class="tdstyle">(英文)导师</td>
	        <td colspan="2"><input type="text" id="etutor" class="layui-input" disabled="" value="<%=user.etutor%>"></td>
	      </tr>
	      <tr>
	        <td class="tdstyle">论文题目</td>
	        <td ><input type="text" id="thesis" class="layui-input" disabled="" value="<%=user.thesis%>"></td>
	        <td class="tdstyle">(英文)论文题目</td>
	        <td colspan="2"><input type="text" id="ethesis" class="layui-input" disabled="" value="<%=user.ethesis%>"></td>
	      </tr>
	      <tr>
	        <td class="tdstyle">个人主页</td>
	        <td ><input type="text" id="ownurl" class="layui-input" disabled="" value="<%=user.ownurl%>"></td>
	        <td class="tdstyle">毕业时间</td>
	        <td colspan="2"><input type="text" id="graduationdate" class="layui-input" disabled="" value="<%=user.graduationdate%>"></td>
	      </tr>
	      <tr>
	        <td class="tdstyle">毕业去向</td>
	        <td ><input type="text" id="whereabouts" class="layui-input" disabled="" value="<%=user.whereabouts%>"></span></td>
	        <td class="tdstyle">(英文)毕业去向</td>
	        <td colspan="2"><input type="text" id="ewhereabouts" class="layui-input" disabled="" value="<%=user.ewhereabouts%>"></td>
	      </tr>
	      <tr>
	        <td class="tdstyle">个人介绍</td>
	        <td colspan="4"><span id="introduce"></span></td>
	      </tr>
	       <tr>
	        <td class="tdstyle">(英文)个人介绍</td>
	        <td colspan="4"><span id="eintroduce"></span></td>
	        </tr>
	       <tr>
	        <td class="tdstyle">工作简历</td>
	        <td colspan="4"><span id="workresume"></span></td>
	        </tr>
	        <tr>
	          <td class="tdstyle">(英文)工作简历</td>
	          <td colspan="4"><span id="eworkresume"></span></td>
	        </tr>
        </tbody>
  </table>
  </form>

	<script type="text/javascript" src="../layui/layui.js"></script>
	<script type="text/javascript" src="../javascripts/wangEditor.min.js"></script>
	<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>

<script type="text/javascript">
//父页面，接收子页面的值
function getsondata(obj){
	console.log('父页面，接收子页面的值',obj)
}
function back(){
	let editbtn = '<button class="layui-btn layui-btn-sm btnfloat" id="editbtn">编辑</button>'
	$('#uploadbtn').remove()
	$('#btnele').children().remove()
	$('#btnele').append(editbtn)
	$('input').attr("disabled",false); 
	$('select').attr("disabled","disabled"); 
}
layui.use(['jquery','layer','upload','form'], function(){ 
    let $ = layui.$ //重点处
    let layer = layui.layer,upload=layui.upload,form=layui.form

    $('body').on('click', '#editbtn', function() {
    	console.log('edit',$('input'))
    	let saveorbackbtn = '<button class="layui-btn layui-btn-sm btnfloat" id="backbtn" style="margin-right:5px;">返回</button><button class="layui-btn layui-btn-sm btnfloat" id="savebtn" style="margin-right:15px;">保存</button>'
    	$('#btnele').children().replaceWith(saveorbackbtn)
    	$('input').attr("disabled",false); 

    	//性别和类别更新
    	let genderselect = '<select name="gender" lay-filter="gender" id="gender"><option value="1">男</option><option value="0">女</option>'
    	$('#tdgender').children().remove()
    	$('#tdgender').append(genderselect)

    	let degreeselect = '<select name="degree" lay-filter="degree" id="degree"><option value="教师">教师</option><option value="博士后">博士后</option><option value="博士生">博士生</option><option value="硕士">硕士</option><option value="行政助理">行政助理</option><option value="校友">校友</option><option value="特约/访问学者">特约/访问学者</option>'
    	$('#tddegree').children().remove()
    	$('#tddegree').append(degreeselect)
    	form.render('select')
    	//
    	let uploadbtn = '<button type="button" class="layui-btn" id="uploadbtn">上传头像</button>'
    	$('#uploadarea').append(uploadbtn)
    	let uploadInst  = upload.render({
		    elem: '#uploadbtn'
		    ,url: '/manage/userimgupload'
		    , accept: 'images'
		    ,size: 1024 //限制文件大小，单位 KB
		    ,before: function(obj){
		      //预读本地文件示例，不支持ie8
		      obj.preview(function(index, file, result){
		        $('#demo1').attr('src', result); //图片链接（base64）
		      });
		    }
		    ,done: function(res){
		      //如果上传失败
		      if(res.errno != 0){
		        return layer.msg('上传失败');
		      }else{
		      	console.log('userimg',res.data)
		      	$('#userimg').attr('src',''+res.data)
		      }
		      //上传成功
		    }
		    ,error: function(){
		      //演示失败状态，并实现重传
		      let demoText = $('#demoText');
		      demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
		      demoText.find('.demo-reload').on('click', function(){
		        uploadInst.upload();
		      });
		    }
		  });
    })

    //因为动态添加的元素class属性是无效的，所以不能用$('.add').click(function(){});
	$('body').on('click', '#backbtn', function() {
		console.log('back')
		back()
		$('input').attr("disabled",true); 
	})

	$('body').on('click', '#savebtn', function() {
		console.log('savebtn')
		console.log($('#gender option:selected').val(),$('#degree option:selected').val())
		$.ajax({
			url:'/manage/userinfo',
			type:'post',
			dataType : "json",
			data:{
				name:$('#name').val(),
				ename:$('#ename').val(),
				gender:$('#gender option:selected').val(),
				degree:$('#degree option:selected').val(),
				title:$('#title').val(),
				etitle:$('#etitle').val(),
				phone:$('#phone').val(),
				email:$('#email').val(),
				address:$('#address').val(),
				eaddress:$('#eaddress').val(),
				profession:$('#profession').val(),
				eprofession:$('#eprofession').val(),
				researcharea:$('#researcharea').val(),
				eresearcharea:$('#eresearcharea').val(),
				tutor:$('#tutor').val(),
				etutor:$('#etutor').val(),
				thesis:$('#thesis').val(),
				ethesis:$('#ethesis').val(),
				ownurl:$('#ownurl').val(),
				graduationdate:$('#graduationdate').val(),
				whereabouts:$('#whereabouts').val(),
				ewhereabouts:$('#ewhereabouts').val(),
				introduce:editor1.txt.html(),
				eintroduce:editor2.txt.html(),
				workresume:editor3.txt.html(),
				eworkresume:editor4.txt.html(),
				photo:$('#userimg').attr('src')
			},
			success:function(result){
				console.log('save success')
				layer.alert('保存成功', {
				  skin: 'layui-layer-molv' //样式类名
				  ,closeBtn: 0
				  ,time:2000
				}, function(){
				});
				back()
				  $('input').attr("disabled","disabled"); 
			},
			error:function(error){
				console.log('ajax error',error)
			}
		})
	})


    let E = window.wangEditor
    let editor1 = new E('#introduce'),
    	editor2 = new E('#eintroduce'),
    	editor3 = new E('#workresume'),
    	editor4 = new E('#eworkresume')

	editor1.customConfig.debug = true; //是否开启Debug 默认为false 建议开启 可以看到错误
	editor2.customConfig.debug = true;
	// 自定义菜单配置
	editor1.customConfig.menus = [
	    'head',  // 标题
	    'bold',  // 粗体
	    'fontSize',  // 字号
	    'fontName',  // 字体
	    'italic',  // 斜体
	    'underline',  // 下划线
	    'strikeThrough',  // 删除线
	    'foreColor',  // 文字颜色
	    'backColor',  // 背景颜色
	    'list',  // 列表
	    'justify',  // 对齐方式
	    'quote',  // 引用
	    'emoticon',  // 表情
	    'table',  // 表格
	    'undo',  // 撤销
	    'redo'  // 重复
	];
	editor2.customConfig.menus = [
	    'head',  // 标题
	    'bold',  // 粗体
	    'fontSize',  // 字号
	    'fontName',  // 字体
	    'italic',  // 斜体
	    'underline',  // 下划线
	    'strikeThrough',  // 删除线
	    'foreColor',  // 文字颜色
	    'backColor',  // 背景颜色
	    'list',  // 列表
	    'justify',  // 对齐方式
	    'quote',  // 引用
	    'emoticon',  // 表情
	    'table',  // 表格
	    'undo',  // 撤销
	    'redo'  // 重复
	];
	editor3.customConfig.menus = [
	    'head',  // 标题
	    'bold',  // 粗体
	    'fontSize',  // 字号
	    'fontName',  // 字体
	    'italic',  // 斜体
	    'underline',  // 下划线
	    'strikeThrough',  // 删除线
	    'foreColor',  // 文字颜色
	    'backColor',  // 背景颜色
	    'list',  // 列表
	    'justify',  // 对齐方式
	    'quote',  // 引用
	    'emoticon',  // 表情
	    'table',  // 表格
	    'undo',  // 撤销
	    'redo'  // 重复
	];
	editor4.customConfig.menus = [
	    'head',  // 标题
	    'bold',  // 粗体
	    'fontSize',  // 字号
	    'fontName',  // 字体
	    'italic',  // 斜体
	    'underline',  // 下划线
	    'strikeThrough',  // 删除线
	    'foreColor',  // 文字颜色
	    'backColor',  // 背景颜色
	    'list',  // 列表
	    'justify',  // 对齐方式
	    'quote',  // 引用
	    'emoticon',  // 表情
	    'table',  // 表格
	    'undo',  // 撤销
	    'redo'  // 重复
	];
	
    // 或者 var editor = new E( document.getElementById('editor') )
    editor1.create()
    editor2.create()
    editor3.create()
    editor4.create()

    editor1.txt.html('<%- JSON.stringify(user.introduce).replace(/^\"|\"$/g,'') %>')
    editor2.txt.html('<%- JSON.stringify(user.eintroduce).replace(/^\"|\"$/g,'') %>')
    editor3.txt.html('<%- JSON.stringify(user.workresume).replace(/^\"|\"$/g,'') %>')
    editor4.txt.html('<%- JSON.stringify(user.eworkresume).replace(/^\"|\"$/g,'') %>')
});

</script>
</body>
</html>