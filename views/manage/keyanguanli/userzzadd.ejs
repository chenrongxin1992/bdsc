<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>新增用户专著</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="format-detection" content="telephone=no">
	<link rel="stylesheet" href="../layui/css/layui.css" media="all" />
	<link rel="stylesheet" href="../stylesheets/public.css" media="all" />
	<style type="text/css">
		.filedelbtn{
			margin:0 8px;
		}
		#fujian p {
			margin:2px 0;
		}
		.labelwidth{
			width: 120px;
		}
		.inputwidth{
			width: 100px;
			display:inline;
			margin:0 2px;
		}
		.thtext{
			text-align: center !important;
		}
		#uploadimg{
			display: inline-block;
            position: relative;
		}
		#uploadimg .delete{
			width:32px;
    		height:32px;
    		position:absolute;
    		z-index: 10;
    		left: 190px;
    		top: -10px;
    		cursor:pointer;
		}
	</style>
</head>
<body class="childrenBody">
	<form class="layui-form layui-row layui-col-space10">
		<div class="layui-col-md12 layui-col-xs12">
			<div class="layui-form-item">
				<div class="layui-inline">
					<label class="layui-form-label ">著作名称</label>
					<div class="layui-input-inline" style="width: 272px;">
				      <input type="text" name="name" autocomplete="off" class="layui-input" id="name" lay-verify="required">
				    </div>
				    <label class="layui-form-label labelwidth" >著作名称(EN)</label>
				    <div class="layui-input-inline" style="width: 272px;">
				      <input type="text" name="ename"  autocomplete="off" class="layui-input" id="ename">
				    </div>
				</div>
			</div>

			<div class="layui-form-item">
				<div class="layui-inline">
					<label class="layui-form-label ">全部作者</label>
				</div>
				<div class="layui-inline">
					<table class="layui-table" id="zuozhetable" lay-filter="zuozhetable" style="text-align: center;">
						<thead>
							<tr>
								<th></th><th class="thtext">姓名</th><th class="thtext">单位</th><th class="thtext">通讯作者</th><th class="thtext">本人</th>
							</tr>
						</thead>
						<tbody>
							
						</tbody>
					</table>
					
				</div>
				<div class="layui-inline">
					<a class="layui-btn layui-btn-xs add">添加</a>
					<a class="layui-btn layui-btn-danger layui-btn-xs del">删除</a>
					<a class="layui-btn layui-btn-xs up" >上移</a>
					<a class="layui-btn layui-btn-xs down">下移</a>
				</div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label ">出版社</label>
				<div class="layui-input-inline" style="width: 272px;">
				    <input type="text" name="publish"  autocomplete="off" class="layui-input" id="publish">
				</div> 
				<label class="layui-form-label ">出版社(EN)</label>
				<div class="layui-input-inline" style="width: 272px;">
				    <input type="text" name="epublish"  autocomplete="off" class="layui-input" id="epublish">
				</div> 
	        </div>	

			<div class="layui-form-item">
				<label class="layui-form-label ">出版年份</label>
				<div class="layui-input-inline" style="width: 272px;">
				    <input type="text" name="publishyear"  autocomplete="off" class="layui-input" id="publishyear" lay-verify="">
				</div> 
				<label class="layui-form-label ">ISBN号码</label>
				<div class="layui-input-inline" style="width: 272px;">
				    <input type="text" name="isbn"  autocomplete="off" class="layui-input" id="isbn" lay-verify="">
				</div> 
	        </div>	

	        <div class="layui-form-item">
				<label class="layui-form-label ">页码</label>
				<div class="layui-input-inline" style="width: 272px;">
				    <input type="text" name="pagination"  autocomplete="off" class="layui-input" id="pagination" lay-verify="">
				</div> 
				<label class="layui-form-label ">版本</label>
				<div class="layui-input-inline" style="width: 272px;">
				    <input type="text" name="versions"  autocomplete="off" class="layui-input" id="versions" lay-verify="">
				</div> 
	        </div>	

	        <div class="layui-form-item">
				<label class="layui-form-label ">出版地址</label>
				<div class="layui-input-inline" style="width: 272px;">
				    <input type="text" name="publishaddr"  autocomplete="off" class="layui-input" id="publishaddr" lay-verify="">
				</div> 
				<label class="layui-form-label ">出版地址(EN)</label>
				<div class="layui-input-inline" style="width: 272px;">
				    <input type="text" name="epublishaddr"  autocomplete="off" class="layui-input" id="epublishaddr" lay-verify="">
				</div> 
	        </div>

	        <div class="layui-form-item">
				<label class="layui-form-label">摘要</label>
				<textarea id="digest" class="layui-textarea" style="width: 710px;height: 150px;"  value=""></textarea>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label ">摘要(EN)</label>
				<textarea id="edigest" class="layui-textarea" style="width: 710px;height:150px;" value=""></textarea>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label "></label>
				<div class="layui-input-inline" style="width: 272px;">
				    <button type="button" class="layui-btn" id="upload">
					  <i class="layui-icon">&#xe67c;</i>上传图片
					</button>
				</div> 
	        </div>	

	        <div class="layui-form-item">
	        	<label class="layui-form-label "></label>
	        	<div class="layui-input-inline" style="width: 272px;">
	        		<div id="uploadimg" style="max-width: 100px;">

		    		</div>
	        	</div>
	        </div>

		    <div class="layui-form-item">
		    	<label class="layui-form-label ">关联项目</label>
		    	
		    	<div class="layui-input-inline" >
		    		<div class="layui-input-inline" style="width: 272px;" >
			          <a class="layui-btn layui-btn-sm" id="glxm"><i class="layui-icon">&#xe654;</i>关联</a>
			        </div>
		    	</div>
		    </div>

		    <div id="chooseglxm">

		    </div>

		    <div class="layui-form-item">
				<label class="layui-form-label ">显示在</label>
					<div class="layui-input-block" >
				      <input type="checkbox" name="showin" value="A" title="AAA" id="AAA">
				      <input type="checkbox" name="showin" value="B" title="BBB" id="BBB">
				      <input type="checkbox" name="showin" value="C" title="CCC" id="CCC">
				      <input type="checkbox" name="showin" value="D" title="DDD" id="DDD">
				      <input type="checkbox" name="showin" value="E" title="EEE" id="EEE">
				    </div> 
	       </div>

			<div class="layui-form-item">
				<hr class="layui-bg-gray" />
				<div class="layui-col-md-offset1">
					<button class="layui-btn layui-btn-sm" lay-filter="update" lay-submit id="btnsave"><i class="layui-icon">&#xe609;</i>保存</button>
				</div>
			</div>
		</div>
	</form>

<script type="text/javascript" src="../layui/layui.js"></script>
<script type="text/javascript" src="https://unpkg.com/wangeditor@3.1.1/release/wangEditor.min.js"></script>
<!-- <script type="text/javascript" src="newsAdd.js"></script> -->
<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript">
	//子页面调用函数
	function getSonData(sondata){
		console.log('getSonData',sondata)
		let appendstr = '',count = 0
		$('#chooseglxm').children().remove()
		$.each(sondata,function(index,item){
			count = index + 1
			//如果已经选过，则跳过不append
			appendstr = '<div class="layui-form-item" id="'+item.id+'"><label class="layui-form-label"></label><div class="layui-input-inline" style="min-width:400px;"> '+ count + '  ' + item.name+' </div></div>'
			
			$('#chooseglxm').append(appendstr)
		})
	}
	
	//全部作者
	  function getauthors(){
	  	let tmp = [],str = [],str2 = ''
	  	$('#zuozhetable tbody tr').each(function(index,item){
	  		tmp.push($(item).children().find('input[name="field_name"]').val())
	  		tmp.push($(item).children().find('input[name="field_ename"]').val())
	  		tmp.push($(item).children().find('input[name="field_dept"]').val())
	  		tmp.push($(item).children().find('input[name="field_edept"]').val())
	  		console.log($(item).children().find('input[name="iscorrespondor"]:checked'))
	  		tmp.push(String($(item).children().find('input[name="iscorrespondor"]:checked').length))
	  		tmp.push(String($(item).children().find('input[name="isowner"]:checked').length))
	  		console.log('tmp',index,tmp)
	  		str.push(tmp.join(','))
	  		console.log('str',str)
	  		tmp = []
	  		console.log('tmp',tmp)
	  	})
	  	str2 = str.join(';')
	  	console.log('全部作者',str2)
	  	return str2
	  }
	   //关联项目id合并
	  function relevanceproid(){
	  	let str = ''
	  	$('#chooseglxm').children().each(function(){
	  		if($(this).attr('id')){
	  			str += $(this).attr('id') + ';'
	  		}
	  	})
	  	console.log('关联项目id',str.substring(0,str.length-1))
	  	return str.substring(0,str.length-1)
	  }
	$(function(){
		let checkadmain = '<%-rolename%>'
		console.log('checkadmain',checkadmain)
		if(checkadmain=='管理员'){
			console.log('管理员可以编辑所有')
		}else{
			console.log('非管理员只能查看，或者在科研管理中发布自己的')
			$('#btnsave').addClass('layui-btn-disabled').attr('disabled',"true");
		}
		layui.use(['jquery','layer','form','laydate','upload'], function(){ 
		    let $ = layui.$, //重点处
		    	laydate = layui.laydate,
		    	upload = layui.upload
		    let form = layui.form,layer = layui.layer
		    let frameindex = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
		    console.log('frameindex',frameindex)
		    //监听下拉
		    //执行实例
			  let uploadInst = upload.render({
			    elem: '#upload' //绑定元素
			    ,url: '/manage/userzzupload' //上传接口
			     ,type: 'iamges' //上传接口
			    ,done: function(res){
			      //上传完毕回调
			      console.log('upload success',res)
			      if($('#uploadimg').children().length!=0){
			      	$('#uploadimg').children().remove()
			      }
			      let str = "<img src="+(res.data)[0]+" alt="+(res.returnfilename)[0]+" style='max-width:200px;' title="+(res.returnfilename)[0]+" name="+(res.data)[0]+"> <img src='/images/button-del.png' class='delete' />"
			      $('#uploadimg').append(str)
			    }
			    ,error: function(){
			      //请求异常回调
			    }
			  });

		    //当访问的时候数据存在，初始化form
		    let id = '<%-data.id%>'
		    let manarr = [],optionstr='',dwarr=[],dwstr=''//关联人员
		    if(id==''||id==null||typeof(id)=='undefined'){
		    	console.log('新增专著登记',id)
		    }else{
		    	console.log('编辑专著登记，需要初始化表单')
		    	$('#name').val('<%-data.name%>')
		    	$('#ename').val('<%-data.ename%>')
		    	$('#publish').val('<%-data.publish%>')
		    	$('#epublish').val('<%-data.epublish%>')
		    	$('#publishyear').val('<%-data.publishyear%>')
		    	$('#isbn').val('<%-data.isbn%>')
		    	$('#pagination').val('<%-data.pagination%>')
		    	$('#versions').val('<%-data.versions%>')
		    	$('#digest').val('<%-data.digest%>')
		    	$('#edigest').val('<%-data.edigest%>')
		    	$('#publishaddr').val('<%-data.publishaddr%>')
		    	$('#epublishaddr').val('<%-data.epublishaddr%>')
		    	$('#publishaddr').val('<%-data.publishaddr%>')
		    	$('#epublishaddr').val('<%-data.epublishaddr%>')
		    	//初始化复选框
		    	let showinstr = '<%- data.showin%>'.split(';')
		    	console.log('showinstr',showinstr)
		    	$.each(showinstr,function(i,item){
		    		if(item=='A'){
		    			$('#AAA').prop('checked',true)
		    		}
		    		if(item=='B'){
		    			$('#BBB').prop('checked',true)
		    		}
		    		if(item=='C'){
		    			$('#CCC').prop('checked',true)
		    		}
		    		if(item=='D'){
		    			$('#DDD').prop('checked',true)
		    		}
		    		if(item=='E'){
		    			$('#EEE').prop('checked',true)
		    		}
		    	})
  				form.render()
		    	//select
		    	//初始化封面
		    	let imgstr = "<img src="+'<%-data.pic%>'+ " style='max-width:200px;' name='<%-data.pic%>'> <img src='/images/button-del.png' class='delete' />"
		    	console.log('imgstr',imgstr)
		    	$('#uploadimg').append(imgstr)
		    	console.log('imgstr',$('#uploadimg'))
  				//初始化作者
  				let authors = '<%-data.authors%>',
  					authorsarr = authors.split(';')
  					$.each(authorsarr,function(index,item){
  						let tmp = item.split(',')
  						let check1str = '',check2str=''
  						if(tmp[4] == 1){
  							check1str = 'checked="true"'
  						}
  						if(tmp[5] == 1){
  							check2str = 'checked="true"'
  						}
  						let appendstr = '<tr>' + 
  										'<td><input type="radio" name="row"></td>' +
  										'<td><input type="text" name="field_name" class="layui-input inputwidth" value="'+tmp[0]+'"><input type="text" name="field_ename" class="layui-input inputwidth" value="'+tmp[1]+'"></td>' +
  										'<td><input type="text" name="field_dept" class="layui-input inputwidth" value="'+tmp[2]+'"><input type="text" name="field_edept" class="layui-input inputwidth" value="'+tmp[3]+'"></td>' +
  										'<td><input type="checkbox" name="iscorrespondor" lay-skin="primary" '+check1str+'></td>' +
  										'<td><input type="checkbox" name="isowner" lay-skin="primary" '+check2str+'></td>' 
  							$(appendstr).appendTo($('#zuozhetable tbody:last'))
							form.render()
  					})
  				//初始化关联项目
				$.ajax({
					url:'/manage/getglxmfun',//可共用
					type:'post',
					data:{'relid':id,'tname':'periodical_article'},
					success:function(result){
						console.log('result',result)
						if(result.code==0){
							let count = 0
							console.log('result',result)
							if(result.data==null){
									$.each(result.data,function(index,item){
									count = index + 1
									//如果已经选过，则跳过不append
									appendstr = '<div class="layui-form-item" id="'+item.id+'"><label class="layui-form-label"></label><div class="layui-input-inline" style="min-width:400px;"> '+ count + '  ' + item.name+' </div></div>'
									
									$('#chooseglxm').append(appendstr)
								})
								}else{return false}
							
						}
					},
					error:function(msg){
						console.log('getrelevancepro err',msg)
					}
				})
  					
		    }
		    $('body').on('click', '.delete', function() {
		    	console.log('$(this)',$(this))
		    	$(this).parent().children().remove()
		    })
			//因为动态添加的元素class属性是无效的，所以不能用$('.add').click(function(){});
				$('body').on('click', '.add', function() {
					console.log('添加作者',$('#zuozhetable tbody tr').length)
					let num = 1
					if($('#zuozhetable tbody tr').length != 0){
						num=$('#zuozhetable tbody tr').length+1
					}
					let appendstr = '<tr>' + 
									'<td><input type="radio" name="row"></td>' +
									'<td><input type="text" name="field_name" class="layui-input inputwidth" placeholder="中文"><input type="text" name="field_ename" class="layui-input inputwidth"  placeholder="英文"></td>' +
									'<td><input type="text" name="field_dept" class="layui-input inputwidth"  placeholder="中文"><input type="text" name="field_edept" class="layui-input inputwidth" placeholder="英文"></td>' +
									'<td><input type="checkbox" name="iscorrespondor" lay-skin="primary"></td>' +//去掉通讯作者
									'<td><input type="checkbox" name="isowner" lay-skin="primary"></td>' 
					$(appendstr).appendTo($('#zuozhetable tbody:last'))
					form.render()
				})
			//删除一行
			$('body').on('click', '.del', function() {
				console.log('del',$(this))
				//获取radio
				if($('input:radio:checked').length==0){
					console.log('请选择一行')
					layer.msg('请选择一行', {
						time : 2000
					});
				}else{
					//删除当前按钮所在的tr
					console.log($('input:radio:checked').parent())
					$('input:radio:checked').closest('tr').remove();
				}
			})
			//上移
			$('body').on('click','.up',function(){
				console.log('上移')
			  	if($('input:radio:checked').length==0){
					console.log('请选择一行')
					layer.msg('请选择一行', {
						time : 2000
					});
				}else{
					let curtr = $('input:radio:checked').parent().parent(),
						prev = curtr.prev()
						console.log('curtr',curtr,prev)
						if(curtr.index()>0){
					  		curtr.insertBefore(prev)
					  	}else{
					  		layer.msg('已经是最顶部了')
					  		return 
					  	}
				}
			})
			//下移
			$('body').on('click','.down',function(){
				console.log('下移')
				if($('input:radio:checked').length==0){
					console.log('请选择一行')
					layer.msg('请选择一行', {
						time : 2000
					});
				}else{
					let curtr = $('input:radio:checked').parent().parent(),
						next = curtr.next()
						if(next.next().html()==null){
				  		layer.msg('已经是最底部了')
				  		return 
				  	}else{
				  		curtr.insertAfter(next)
				  	}
				}
			})
			
			$('#glxm').on('click',function(){
				console.log('弹框的时候需要将已选项目传到子页面判断是否已选')
				console.log('length',$('#chooseglxm').children())
				let idarr = []
				if($('#chooseglxm').children().length!=0){
					console.log('有已选项目')
					$.each($('#chooseglxm').children(),function(index,item){
						idarr.push($(item).attr('id'))
					})
					console.log('idarr',idarr)
				}
				json = JSON.stringify(idarr)
				console.log('父页面json',json)
				layer.open({
				  title: '关联项目',
				  type: 2,
				  area: ['700px', '450px'],
				  fixed: false, //不固定
				  maxmin: true,
				  content: '/manage/glxm'//可共用
				});
			})
		    
		    form.on('submit(update)', function(data){
		    	 //复选框
            let showinarr = new Array();
            $("input:checkbox[name='showin']:checked").each(function(i){
                showinarr.push($(this).val())
            })
			console.log('showinarr',showinarr)
			showinarr = showinarr.join(';')
			console.log('showinarr',showinarr)
			  //更新
			  console.log('submit data',data)
			  console.log('pic',$('#uploadimg').children())
			  data.field.id = id
			  data.field.name = $('#name').val()
			  data.field.ename = $('#ename').val()
			  data.field.publish = $('#publish').val()
			  data.field.epublish = $('#epublish').val()
			  data.field.publishyear = $('#publishyear').val()
			  data.field.isbn = $('#isbn').val()
			  data.field.pagination = $('#pagination').val()
			  data.field.versions = $('#versions').val()
			  data.field.digest = $('#digest').val()
			  data.field.edigest = $('#edigest').val()
			  data.field.publishaddr = $('#publishaddr').val()
			  data.field.epublishaddr = $('#epublishaddr').val()
			  data.field.authors = getauthors()
			  data.field.pic = $('#uploadimg').children(':first').attr('name')
			  data.field.relevanceproid = relevanceproid()
			  data.field.showin = showinarr
			  //return false
			  console.log('专著登记 add  data field',data.field);
			  $.ajax({
			  	url:'/manage/userzzadd',
			  	type:'POST',
			  	data:data.field,
			  	dataType : "json",
			  	success:function(result){
			  		if(result.code == 0){
			  			console.log('update success')
			  			//墨绿深蓝风
						layer.alert('保存成功', {
						  skin: 'layui-layer-molv' //样式类名
						  ,closeBtn: 0
						  ,time : 2000
						}, function(){
							layer.close(frameindex);
						});	  			
			  		}
			  	},
			  	error:function(msg){
			  		console.log('ajax error msg',msg)
			  	}
			  })
			});
		})
	})
</script>
</body>
</html>