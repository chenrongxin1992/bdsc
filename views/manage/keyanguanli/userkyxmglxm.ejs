<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>关联项目(用户新增关联成果)</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="format-detection" content="telephone=no">
	<link rel="stylesheet" href="../layui/css/layui.css" media="all" />
	<link rel="stylesheet" href="../stylesheets/public.css" media="all" />
</head>
<body class="childrenBody">

	<div class="demoTable layui-form">
	  <div class="layui-inline">
	    <input class="layui-input" name="name" id="name" autocomplete="off" placeholder="成果名称">
	  </div>
	  <button class="layui-btn" data-type="reload" id="glcg_btn">搜索</button>
	  <button class="layui-btn layui-right" id="confirm_btn">确认</button>
	</div>

	<table id="glcg_table" lay-filter="glcg_table"></table>
	

<script type="text/javascript" src="../layui/layui.js"></script>
<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript">
$(function(){
	let parentjson = eval('('+parent.jsonidarr+')'),
		jsontnamearr = eval('('+parent.jsontnamearr+')')
	console.log('目前在子页面，父页面传过来的json是',parentjson,jsontnamearr)
	let choosedata = []
	layui.use(['jquery','table','form'], function(){ 
	    let $ = layui.$ //重点处
	    let table = layui.table,
	    	form = layui.form
	    form.render('select')
	    table.render({
		    elem: '#glcg_table'
		    ,id:'table_glcg'//重载需要
		    ,cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
		    ,url: '/manage/userkyxmglcg_data' //数据接口
		    ,page: false //开启分页
		    ,cols: [[ //表头
		      {type:'numbers',title: '序号'}
		      ,{type: 'checkbox',templet:'#checkboxtpl'}
		      //,{field: 'id', title: '序号',width:90,align:'center'}
		      ,{field: 'achname', title: '项目名称',align:'center'}
		      ,{field: 'glcgname', title: '成果类型',align:'center',width:120}
		    ]]
		    ,done:function(res,curr,count){
		    	console.log('表格初始化完成，判断是否有已选项目，将父页面的json和表格数据对比',res,curr,count)
		    	let tabledata = res.data
		    	//循环所有数据，找出对应关系，设置checkbox选中状态
		    	for(let i=0;i<parentjson.length;i++){
		    		for(let j=0;j<tabledata.length;j++){
		    			if(parentjson[i]==tabledata[j].achid&&jsontnamearr[i]==tabledata[j].tname){
		    				console.log('找到匹配项目')
		    				console.log(tabledata[j])
		    				choosedata.push(tabledata[j])
		    				tabledata[j]['LAY_CHECKED'] = 'true'
		    				let index = tabledata[j]['LAY_TABLE_INDEX']
		    				console.log('循环中的 index',index)
		    				$('tr[data-index=' + index + '] input[type="checkbox"]').prop('checked', true);
                            $('tr[data-index=' + index + '] input[type="checkbox"]').next().addClass('layui-form-checked');
		    			}
		    		}
		    	}
		    }
		  });
	    //数据重载
	    $('#glcg_btn').on('click', function(){
	    	table.reload('table_glcg', {
		        where: {
		            name: $('#name').val()
		        }
		    });
	    })
	    //监听确认
	    $('#confirm_btn').on('click', function(){
	    	console.log('点击确认按钮')
	    	console.log('选择的数据是',choosedata)
	    	
	    		console.log('传递数据到父页面')
	    		parent.getSonData(choosedata)//调用父页面函数
	    		let index = parent.layer.getFrameIndex(window.name)
	    		console.log('index',index)
	    		parent.layer.close(index)
	    	
	    })
	    //监听复选框
	    
		table.on('checkbox(glcg_table)', function(obj){ //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
		  let checkstatus = table.checkStatus('table_glcg')
		  console.log('checkstatus',checkstatus)
		  if(checkstatus.isAll){
		  	console.log('全选')
		  	choosedata = checkstatus.data
		  }else{
		  	console.log('没有全选')
		  	choosedata = checkstatus.data
		  }
		});
	});
})

</script>
<script type="text/html" id="yjfxbar">
  <a class="layui-btn layui-btn-xs" lay-event="edit">查看 | 编辑</a>
  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
<script type="text/html" id="checkboxtpl">

</script>
</body>
</html>